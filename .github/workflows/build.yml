name: Build and Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        global-json-file: global.json

    - name: Restore NuGet packages
      run: dotnet restore atlang.sln

    - name: Build the solution
      run: dotnet build atlang.sln --configuration Release --no-restore

    - name: Run tests
      id: run-tests
      continue-on-error: true
      run: dotnet test atlang.sln --no-build --configuration Release --verbosity normal -p:TestingPlatformCommandLineArguments="--report-trx --results-directory TestResults/ --coverage"

    - name: Upload test results
      if: always() && steps.run-tests.outcome != 'skipped'
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: test/TestResults/

    - name: Fail pipeline if tests failed
      if: steps.run-tests.outcome == 'failure'
      run: |
        echo "Tests failed. Failing pipeline."
        exit 1

    - name: Publish self-contained compiler for all RIDs
      run: bash build/publish.sh

    - name: Upload compiler artifact (win-x64)
      uses: actions/upload-artifact@v4
      with:
        name: compiler-win-x64
        path: published/win-x64

    - name: Upload compiler artifact (win-x86)
      uses: actions/upload-artifact@v4
      with:
        name: compiler-win-x86
        path: published/win-x86

    - name: Upload compiler artifact (win-arm64)
      uses: actions/upload-artifact@v4
      with:
        name: compiler-win-arm64
        path: published/win-arm64

    - name: Upload compiler artifact (linux-x64)
      uses: actions/upload-artifact@v4
      with:
        name: compiler-linux-x64
        path: published/linux-x64

    - name: Upload compiler artifact (linux-musl-x64)
      uses: actions/upload-artifact@v4
      with:
        name: compiler-linux-musl-x64
        path: published/linux-musl-x64

    - name: Upload compiler artifact (linux-musl-arm64)
      uses: actions/upload-artifact@v4
      with:
        name: compiler-linux-musl-arm64
        path: published/linux-musl-arm64

    - name: Upload compiler artifact (linux-arm)
      uses: actions/upload-artifact@v4
      with:
        name: compiler-linux-arm
        path: published/linux-arm

    - name: Upload compiler artifact (linux-arm64)
      uses: actions/upload-artifact@v4
      with:
        name: compiler-linux-arm64
        path: published/linux-arm64

    - name: Upload compiler artifact (linux-bionic-arm64)
      uses: actions/upload-artifact@v4
      with:
        name: compiler-linux-bionic-arm64
        path: published/linux-bionic-arm64

    - name: Upload compiler artifact (linux-loongarch64)
      uses: actions/upload-artifact@v4
      with:
        name: compiler-linux-loongarch64
        path: published/linux-loongarch64

    - name: Upload compiler artifact (osx-x64)
      uses: actions/upload-artifact@v4
      with:
        name: compiler-osx-x64
        path: published/osx-x64

    - name: Upload compiler artifact (osx-arm64)
      uses: actions/upload-artifact@v4
      with:
        name: compiler-osx-arm64
        path: published/osx-arm64

    - name: Upload compiler artifact (ios-arm64)
      uses: actions/upload-artifact@v4
      with:
        name: compiler-ios-arm64
        path: published/ios-arm64

    - name: Upload compiler artifact (iossimulator-arm64)
      uses: actions/upload-artifact@v4
      with:
        name: compiler-iossimulator-arm64
        path: published/iossimulator-arm64

    - name: Upload compiler artifact (iossimulator-x64)
      uses: actions/upload-artifact@v4
      with:
        name: compiler-iossimulator-x64
        path: published/iossimulator-x64

    - name: Upload compiler artifact (android-arm64)
      uses: actions/upload-artifact@v4
      with:
        name: compiler-android-arm64
        path: published/android-arm64

    - name: Upload compiler artifact (android-arm)
      uses: actions/upload-artifact@v4
      with:
        name: compiler-android-arm
        path: published/android-arm

    - name: Upload compiler artifact (android-x64)
      uses: actions/upload-artifact@v4
      with:
        name: compiler-android-x64
        path: published/android-x64

    - name: Upload compiler artifact (android-x86)
      uses: actions/upload-artifact@v4
      with:
        name: compiler-android-x86
        path: published/android-x86
